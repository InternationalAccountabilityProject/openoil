<link rel="import" href="../components/polymer/polymer.html">
<link rel="import" href="../components/paper-input/paper-input.html">

<polymer-element name="iilab-search" noscript attributes="strings search">
  <template>
    <script src="../components/jquery/dist/jquery.js"></script>
    <script src="../components/jquery-ui/jquery-ui.js"></script>
    <style type="text/css">
      #selection .ui-autocomplete {
        position: relative;
        top: 30px;
      }
    </style>
    <!-- JQuery Autocomplete in the polymer element -->
    <div class="ui-widget">
      <paper-input label="Search" id="searchfield" inputValue="{{search}}" autofocus flex></paper-input>
<!--      <input label="Search" id="searchfield" value="{{search}}" class="autocomplete" flex>-->
    </div>
  </template>
  <script>
    Polymer('iilab-search', {
      stringsChanged: function(oldValue, newValue) {
//        console.log("stringsChanged - in iilab-search")
//        console.log(newValue)        
      },
      searchChanged: function(oldValue, newValue) {
//        console.log(newValue)
      },
      domReady: function() {
        // Autocomplete
        document.querySelector('openoil-app').shadowRoot.querySelector('iilab-search').shadowRoot.querySelector('paper-input').shadowRoot.olderShadowRoot.querySelector('#input').focus()
        document.addEventListener('graph-ready', this.installAutocomplete);
      },
      installAutocomplete: function (e) {
        console.log("autocomplete!")
        var searchfield = document.querySelector('openoil-app').shadowRoot.querySelector('iilab-search').shadowRoot.querySelector('paper-input').shadowRoot.olderShadowRoot.querySelector('#input');
        $(searchfield).autocomplete({
//          my : "right top", 
//          at: "right bottom",
          position: { my: "left bottom", at: "left top", collision: "flip" },
          source: e.detail.strings,
          appendTo: document.querySelector('openoil-app').shadowRoot.querySelector('#selection'),
          focus: function( event, ui){
              var viz = d3.select(document.querySelector('openoil-app').shadowRoot.querySelector('iilab-graph').shadowRoot.querySelector('#viz'))
              viz.selectAll('g.node circle')
                  .transition()
                  .attr("fill", e.detail.chart.style()['node.Company'].color)
                  .attr("stroke-width", "4px")
                  .attr("opacity", "1")
              viz.selectAll('g.node text')
                  .transition()
                  .attr("fill", "#2a3e92")
              viz.selectAll('#' + ui.item.value + ' circle')
                  .transition()
                  .attr("stroke-opacity", "0.5")
                  .attr("stroke-width", "32px")
                  .attr("fill", "#2a3e92")
              viz.selectAll('#' + ui.item.value + ' text')
                  .transition()
                  .attr("fill", "#FFF")

              $(searchfield).val(ui.item.label)
            event.preventDefault();
          },
          response: function( event, ui){
//              console.log(ui)
              var viz = d3.select(document.querySelector('openoil-app').shadowRoot.querySelector('iilab-graph').shadowRoot.querySelector('#viz'))
              
              for (var i in ui.content) {
                viz.selectAll("#" + ui.content[i].value+ " circle")
                  .transition()
                  .attr("fill", "#2a3e92")
                  .attr("opacity", "0.5")
              }
              selectionStyle = document.querySelector('openoil-app').shadowRoot.querySelector('#selection ul').style
              selectionStyle.top = "-10px"
              selectionStyle.left = "500px"
              selectionStyle.width = "400px"
              selectionStyle.position = "absolute"
          },
          search: function( event, ui){
  //            console.log(chart.style())
  //            console.log(chart.style()['node.Company'].color)
              var viz = d3.select(document.querySelector('openoil-app').shadowRoot.querySelector('iilab-graph').shadowRoot.querySelector('#viz'))
              
              viz.selectAll("g.node circle")
                  .transition()
                  .attr("fill", e.detail.chart.style()['node.Company'].color)
          },
          close: function( event, ui){
  //            console.log(chart.style())
  //            console.log(chart.style()['node.Company'].color)
//              d3.select(document.querySelector('openoil-app').shadowRoot.querySelector('iilab-graph').shadowRoot.querySelector('#viz'))
 //                 .selectAll("g.node circle")
  //                .transition()
  //                .attr("fill", e.detail.chart.style()['node.Company'].color)
          },
          select: function( event, ui ) {
              event.preventDefault();
              $(searchfield).val(ui.item.label);
              var viz = d3.select(document.querySelector('openoil-app').shadowRoot.querySelector('iilab-graph').shadowRoot.querySelector('#viz'))
              viz.selectAll('#' + ui.item.value + ' circle')
                  .transition()
                  .attr("stroke-opacity", "0.5")
                  .attr("stroke-width", "32px")
                  .attr("fill", "#2a3e92")
              viz.selectAll('#' + ui.item.value + ' text')
                  .transition()
                  .attr("fill", "#FFF")
                  console.log(event)
              document.querySelector('openoil-app').shadowRoot.querySelector('iilab-graph').fire('search-select', {node: '#' + ui.item.value})
//              PK.render(ui.item.value);
          }
        })
      }
    })
/*    $(function(){
      // Store a reference to the original contains method.
      var originalContains = jQuery.contains;
      console.log("hi!")
      jQuery.contains = function(parent, child){
          console.log(child)
          var re = /ui-widget|autocomplete/i;
          if(child.className.match(re)) {
            return true;
          }
          // Execute the original method.
          return originalContains.apply( this, arguments );
      }
    });*/
	</script>
</polymer-element>