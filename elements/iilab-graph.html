<link rel="import" href="../components/polymer/polymer.html">
<link rel="import" href="../components/paper-shadow/paper-shadow.html">
<link rel="import" href="../components/paper-button/paper-button.html">
<link rel="import" href="../components/core-item/core-item.html">
<link rel="import" href="../components/core-menu/core-menu.html">
<link rel="import" href="../components/core-menu/core-submenu.html">
<link rel="import" href="iilab-description.html">

<polymer-element name="iilab-graph" noscript attributes="search url description cypher depth strings zoom autozoom chart">
  <style>
      .d3-tip {
      background-color: white;
      border-color: #E2E2E2;
      color: #454545;
      border-radius: 2px;
      width: 400px;
      border-width: 1px;
      border-style: solid;
      font-size: 18.5px;
      line-height: 12px;
      direction: ltr;
      box-shadow: none;
      padding: 0px;
    }

    .d3-tip ul li {
      list-style: none;
      margin:14px 0px 0px;
      font-size: 0.8em;
      padding-right:10px;
    }

    /* Creates a small triangle extender for the tooltip */
    .d3-tip:after {
      box-sizing: border-box;
      display: inline;
      font-size: 10px;
      width: 100%;
      line-height: 1;
      color: white;
      content: "\25BC";
      position: absolute;
      text-align: center;
    }


    /* Style northward tooltips differently */
    .d3-tip.n:after {
      margin: -1px 0 0 0;
      top: 100%;
      left: 0;
    }

  </style>
  <template>
      <style>
        core-submenu::shadow #submenu {
          margin-left: 10px;
        }
        g.node {
          cursor: pointer;
        }

        g.relationship {
          cursor: pointer;
        }
      </style>
      <iilab-drawer-panel id="iilab_drawer" class="right-drawer" selected="main">
        <div drawer vertical layout>
           <template bind="{{element}}">
            <div vertical layout>
              <core-menu valueattr="label" id="core_menu" theme="core-light-theme" multi selected="0" vertical layout>
                <template if="{{ _type == 'node' }}">
                  <core-submenu icon="list" label="{{ type }} Details" selected="0">
                    <paper-item icon="flag" label="{{ name }}" id="name"></paper-item>
                    <template if="{{ oc_id }}">
                      <paper-item icon="info-outline" label="Open Corporates Id: {{ oc_id }}" id="oc_id"></paper-item>
                    </template>
                    <template if="{{ directors }}">
                      <core-submenu icon="account-circle" label="Directors ({{ directors.length}})" selected="0">
                        <template repeat="{{ director in directors }}">
                          <paper-item flex label="{{ director }}" id="directors"></paper-item>
                        </template>
                      </core-submenu> 
                    </template>
                    <template if="{{ shareholders }}">
                      <core-submenu icon="account-circle" label="Directors ({{ shareholders.length}})" selected="0">
                        <template repeat="{{ shareholder in shareholders }}">
                          <paper-item icon="account-box" label="{{ shareholder }}" icon="check" id="shareholders"></paper-item>
                        </template>
                      </core-submenu> 
                    </template>
                    <template if="{{ license_area }}">
                      <paper-item icon="receipt" label="License Areas: {{ license_area }}" icon="check" id="license_area"></paper-item>
                    </template>
                    <template if="{{ field }}">
                      <paper-item icon="receipt" label="Fields: {{ field }}" icon="check" id="field"></paper-item>
                    </template>
                  </core-submenu>
                </template>
                <template if="{{ _type == 'relationship' }}">
                  <core-submenu icon="info-outline" label="{{ ownership_type }}">
                    <paper-item icon="info" label="{{ source.propertyMap.name }}"></paper-item>
                    <paper-item label="owns"></paper-item>
                    <paper-item icon="info" label="{{ target.propertyMap.name }}"></paper-item>
                    <template if="{{ ownership_status }}"><paper-item icon="info-outline" label="Ownership Status: {{ ownership_status }}%" id="ownership_status"></paper-item></template>
                    <template if="{{ immediate }}"><paper-item icon="info-outline" label="Immediate Ownership: {{ immediate }}%" id="immediate"></paper-item></template>
                    <template if="{{ ultimate }}"><paper-item icon="info-outline" label="Ultimate Ownership: {{ ultimate }}%" id="ultimate"></paper-item></template>
                  </core-submenu> 
                </template>
                <template if="{{ source_url }}">
                  <core-submenu icon="receipt" label="Sources">
                      <template if="{{ confidence }}"><paper-item label="Confidence: {{ confidence }}" id="confidence"></paper-item></template>
                      <template if="{{ source_url }}"><paper-item label="Source URL: {{ source_url }}" id="source_url"></paper-item></template>
                      <template if="{{ source_date }}"><paper-item label="Source Publication Date: {{ source_date }}" id="source_date"></paper-item></template>
                      <template if="{{ source_type }}"><paper-item label="Source Type: {{ source_type }}" id="source_type"></paper-item></template>
                      <template if="{{ log_message }}"><paper-item icon="info-outline" label="Notes: {{ log_message }}%" id="log_message"></paper-item></template>
                  </core-submenu> 
                </template>
                <core-submenu icon="attachment" label="Documents">
                </core-submenu> 
                <core-submenu icon="bookmark-outline" label="Request Data" vertical layout>
                    <paper-input floatinglabel label="Email" icon="email" id="email"></paper-input>
                    <paper-input floatinglabel label="First Name" icon="account" id="first_name"></paper-input>
                    <paper-input floatinglabel label="Last Name" icon="account" id="last_name"></paper-input>
                    <paper-input floatinglabel label="Company" icon="flag" id="company"></paper-input>
                    <paper-input multiline label="Type of data to research" icon="query" id="query"></paper-input>
                    <div center>
                      <paper-button negative label="Cancel" icon="cancel"></paper-button>
                      <paper-button affirmative default label="Submit" icon="check"></paper-button>
                    </div>
                </core-submenu> 
              </core-menu>
            </div>
          </template>
          <paper-button on-click="{{buttonClick}}"></paper-button>
          <paper-shadow z="1"></paper-shadow>
        </div>
        <div main><svg id="viz"></svg></div>
      </iilab-drawer-panel>
  </template>
  <script src="../components/d3/d3.min.js"></script>
  <script src="../components/d3-tip/index.js"></script>
  <script src="../components/neod3/neod3.js"></script>
  <script src="neod3-iilab.js"></script>
  <script src="../components/jquery/dist/jquery.js"></script>
  <script src="../components/jquery-ui/jquery-ui.js"></script>
  <script src="../components/neo4j-js.js"></script>
  <script src="iilab-graph.js"></script>
  <script>
    Polymer('iilab-graph', {
//      cypher: "MATCH (a:Company {name: 'BP P L C'})-[r:IS_OWNER*0..2]->(n) RETURN n, labels(n) as label, r",
      cypher: "",
      depth: 2,
      count: 0,
      element: { 
          _type: "",
          type: "",
          name: "",
          oc_id: "",
          directors: "",
          shareholders: "",
          license_area: "",
          field:"",
          confidence:"",
          ownership_status: "",
          source_url: "",
          source_type: "",
          source_date: "",
          log_message: ""
      },
      autozoom: true,
      created: function() {
        this.parameters= {}
      },
      domReady: function() {
//        this.chart = startGraph(this.$.viz, this)
//        console.log(this.chart)
        console.log(this)
        startGraph(this.$.viz, this)
      },
      buttonClick: function(e) {
        this.$.drawer.togglePanel()
      },
      cypherChanged: function(oldValue, newValue) {
        console.log(oldValue)
        console.log(newValue)
        var timer = null;
        var interval = 300;
        function retryIfRunning() {
          if (document.body.classList.contains('loading')) {
              console.log('waiting')
              timer = setTimeout(retryIfRunning, interval);
          }
          else {
            timer = null;
            document.body.classList.add('loading');
            console.log(document.querySelector('openoil-app').shadowRoot.querySelector('iilab-graph').url)
            startGraph(document.querySelector('openoil-app').shadowRoot.querySelector('iilab-graph').shadowRoot.querySelector('#viz'), document.querySelector('openoil-app').shadowRoot.querySelector('iilab-graph'))
          }
        }

        retryIfRunning();
      }
    });
  </script>
</polymer-element>